#!/bin/bash

source /usr/share/yunohost/helpers

borg_with_env_vars="$install_dir/wrapper/borg"

#=================================================
# SPECIFIC GETTERS FOR TOML SHORT KEY
#=================================================

get__on_calendar() {
# YAML seems to hate systemd timer patterns like `*-*-* 03:30:00` so format custom YAML manually
    cat << EOF
    value: '$(ynh_app_setting_get --app="$app" --key="on_calendar")'
EOF
}

get__info() {
    cat << EOF
ask:
  en: "**Backup state:** ${old[state]}

    **Last run**: ${old[last_run]}"
  fr: "**État de la sauvegarde :** ${old[state]}

    **Dernière exécution :** ${old[last_run]}"
EOF
    if [ "${old[state]}" == "failed" ]; then
        cat << EOF
style: "danger"
EOF
    elif [ "${old[state]}" == "successful" ]; then
        cat << EOF
style: "success"
EOF
    else
        cat << EOF
style: "info"
EOF
    fi
}

get__ssh_public_key() {
    cat "/root/.ssh/id_${app}_ed25519.pub" 2>/dev/null || echo "N/A"
}

get__data_multimedia() {
    if [ -e /home/yunohost.multimedia/.nobackup ]; then
        echo "value: false"
    else
        echo "value: true"
    fi
}

get__last_backups() {

    local backup_list
    # Source the env file inside the command substitution ("$(...)")
    # so the variables don't pollute the rest of the function and of the script.
    # Indeed the command substitution spawns a subshell which is convenient here.
    backup_list=$(ynh_exec_as_app "$borg_with_env_vars" list --short --last 50 "${repository}" 2> /dev/null)

    if [ -z "$backup_list" ]; then
        echo 'ask: "*no backups yet*"'
    else
        cat << EOF
ask: |-
$(sed 's/^/  /g' <<< "$backup_list")
EOF
    fi
}

get__conf() {
    ynh_app_setting_get --key=conf
}

#=================================================
# SPECIFIC VALIDATORS FOR TOML SHORT KEYS
#=================================================
validate__on_calendar() {

    (systemd-analyze calendar "$on_calendar" > /dev/null) ||
        echo 'Please follow systemd OnCalendar format: https://man.archlinux.org/man/systemd.time.7#CALENDAR_EVENTS'
}

#=================================================
# SPECIFIC SETTERS FOR TOML SHORT KEYS
#=================================================

set__repository() {
    ynh_app_setting_set --app="$app" --key=repository --value="$repository"
    ynh_add_config --template="env.jinja" --destination="$install_dir/.env" --jinja
}

set__data_multimedia() {
    if [ "$data_multimedia" == "0" ]; then
        mkdir -p /home/yunohost.multimedia/
        touch /home/yunohost.multimedia/.nobackup
    else
        ynh_safe_rm /home/yunohost.multimedia/.nobackup
    fi
}

set__conf() {
    if [ -n "${conf}" ]
    then
        # Update the config of the app
        ynh_app_setting_set --key=conf --value=$conf
    fi
}

set__on_calendar() {
    ynh_app_setting_set --app=$app --key="on_calendar" --value="$on_calendar"
    ynh_add_config --template="systemd.timer" --destination="/etc/systemd/system/$app.timer"
    systemctl daemon-reload
}

set__remote_path() {
    ynh_app_setting_set --app="$app" --key=remote_path --value="$remote_path"
    ynh_add_config --template="env.jinja" --destination="$install_dir/.env" --jinja
}

#=================================================
ynh_app_config_run $1
